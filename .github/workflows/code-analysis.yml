name: Code Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  analyze:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Full history for trend analysis
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install code-analyzer
      run: |
        pip install -e .
    
    - name: Run Analysis
      run: |
        code-analyzer analyze . --depth deep --output .code-analyzer
    
    - name: Check for Critical Issues
      run: |
        # Fail if critical issues found
        python -c "
import json
with open('.code-analyzer/analysis.json') as f:
    data = json.load(f)
    critical = data['metrics']['issues_by_severity'].get('critical', 0)
    high = data['metrics']['issues_by_severity'].get('high', 0)
    if critical > 0:
        print(f'‚ùå Found {critical} critical issues')
        exit(1)
    if high > 5:
        print(f'‚ö†Ô∏è  Found {high} high severity issues (threshold: 5)')
        exit(1)
    print('‚úÖ Quality checks passed')
"
    
    - name: Upload Analysis Results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: code-analysis
        path: .code-analyzer/
    
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const analysis = JSON.parse(fs.readFileSync('.code-analyzer/analysis.json', 'utf8'));
          const metrics = analysis.metrics;
          
          const comment = `## üìä Code Analysis Results
          
**Quality Metrics:**
- Total Issues: ${metrics.total_issues}
- Critical: ${metrics.issues_by_severity.critical || 0}
- High: ${metrics.issues_by_severity.high || 0}
- Medium: ${metrics.issues_by_severity.medium || 0}
- Low: ${metrics.issues_by_severity.low || 0}

**Code Metrics:**
- Average Complexity: ${metrics.average_complexity.toFixed(2)}
- Max Complexity: ${metrics.max_complexity}
- Total Files: ${metrics.total_files}
- Total Lines: ${metrics.total_lines.toLocaleString()}

[View Full Report](${{github.server_url}}/${{github.repository}}/actions/runs/${{github.run_id}})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
